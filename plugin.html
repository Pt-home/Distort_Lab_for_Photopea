<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Distort Lab – Photopea Plugin3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#151823; --line:#24283b; --text:#e6e6ea; --muted:#9aa0a6; --accent:#00a592;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--panel); color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{ padding:12px; width:100%; max-width:520px; }
    h1{ font-size:16px; margin:0 0 6px; }
    p{ margin:0 0 10px; color:var(--muted); }
    .btn{ width:100%; border:0; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:600; background:var(--accent); color:white; }
    .note{ margin-top:8px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Distort Lab for Photopea</h1>
    <p>Send the active layer to Distort Lab, tweak distortions, then export back as a new Photopea document.</p>
    <button id="sendBtn" class="btn">Send to Lab</button>
    <div class="note" id="status"></div>
  </div>

  <script>
  (function(){
    // ---------------- Config ----------------
    const LAB_URL         = "https://pt-home.github.io/Distort_Lab_for_Photopea/";
    const PHOTOPEA_ORIGIN = "https://www.photopea.com";
    const LAB_ORIGIN      = "https://pt-home.github.io";

    const READY_TIMEOUT_MS    = 1800;
    const READY_RETRIES       = 2;
    const APPLIED_TIMEOUT_MS  = 1300;
    const APPLIED_RETRIES     = 1;

    // Buffer collection windows around saveToOE
    const PRE_BUFFER_WINDOW_MS  = 300;
    const POST_BUFFER_WINDOW_MS = 220;

    // ---------------- State ----------------
    let sessionId   = null;
    let labWin      = null;
    let labIsReady  = false;

    // Current send operation
    let op = null; // { id, armed, sent, buffers[], windowTimer, lastPreBuf:{ab,t} }

    // Pending delivery to Lab
    let pendingPng  = null;
    let pendingName = "from-photopea.png";
    let pendingSeq  = -1;
    let seqCounter  = 0;
    let appliedTimer = null;
    let appliedTries = 0;

    const statusEl = document.getElementById("status");
    const sendBtn  = document.getElementById("sendBtn");

    // --------------- Logging helpers ---------------
    const L  = (...a)=>console.log("[DL-PLUGIN]", ...a);
    const LP = (...a)=>console.log("%c[DL-PP]", "color:#9aa0a6", ...a);
    const LL = (...a)=>console.log("%c[DL-LAB]", "color:#58a6ff", ...a);
    const setStatus = (m)=> statusEl.textContent = m;

    // --- CRC32 for buffer identity (debug) ---
    function crc32_ab(ab){
      let crc = 0 ^ (-1);
      const view = new Uint8Array(ab);
      for (let i=0; i<view.length; i++){
        crc = (crc ^ view[i]) >>> 0;
        for (let j=0;j<8;j++){
          const mask = -(crc & 1);
          crc = (crc >>> 1) ^ (0xEDB88320 & mask);
        }
      }
      return (crc ^ (-1)) >>> 0;
    }

    function ensureSession(){
      if (!sessionId) sessionId = "sess-" + Math.random().toString(36).slice(2);
      return sessionId;
    }

    function openOrFocusLab(){
      ensureSession();
      const url = LAB_URL + "?sessionId=" + encodeURIComponent(sessionId);
      if (!labWin || labWin.closed) {
        labWin = window.open(url, "_blank");
        labIsReady = false;
        setStatus("Opening Distort Lab…");
        L("Opened Lab tab:", url);
      } else {
        labWin.focus();
        sendLAB_OPEN();
        setStatus("Distort Lab focused.");
      }
    }

    function sendLAB_OPEN(){
      if (!labWin || labWin.closed) return;
      const msg = { type:"LAB_OPEN", sessionId };
      labWin.postMessage(msg, LAB_ORIGIN);
      LL("→ LAB_OPEN", msg);
    }

    // ---------------- Build PP script for this op ----------------
    function buildPhotopeaScript(opId){
      const tmpName = "DL Temp " + Date.now(); // unique temp document name per op
      return `
      (function(){
        try{
          app.echoToOE("pp:op:${opId}:begin");
          var src = app.activeDocument;
          if (!src){ app.echoToOE("pp:op:${opId}:err:no-doc"); return; }

          var ly = src.activeLayer;
          if (!ly){ app.echoToOE("pp:op:${opId}:err:no-active-layer"); return; }

          try { ly.copy(); app.echoToOE("pp:op:${opId}:copy"); }
          catch(e){ app.echoToOE("pp:op:${opId}:err:copy:"+e); return; }

          var w = src.width  || 1024;
          var h = src.height || 1024;
          var res  = src.resolution || 72;
          var mode = src.mode || "RGB";
          if (typeof mode !== "string") mode = "RGB";

          var tmp = app.documents.add(w, h, res, "${tmpName}", mode);
          app.echoToOE("pp:op:${opId}:new:"+w+"x"+h+"@"+res+" "+mode+" name="+tmp.name);

          try { tmp.paste(); app.echoToOE("pp:op:${opId}:paste"); }
          catch(e){ app.echoToOE("pp:op:${opId}:err:paste:"+e); try{ tmp.close(); }catch(_){} return; }

          try { tmp.trimTransparent(); app.echoToOE("pp:op:${opId}:trim"); } catch(e){}

          // PRE / POST markers around save
          app.echoToOE("pp:op:${opId}:saveToOE:pre");
          try { tmp.saveToOE("png"); app.echoToOE("pp:op:${opId}:saveToOE:post"); }
          catch(e){ app.echoToOE("pp:op:${opId}:err:saveToOE:"+e); }

          try { tmp.close(); app.echoToOE("pp:op:${opId}:close"); } catch(e){ app.echoToOE("pp:op:${opId}:err:close:"+e); }

          try { app.activeDocument = src; } catch(e){}
          app.echoToOE("pp:op:${opId}:done");
        }catch(err){
          app.echoToOE("pp:op:${opId}:err:outer:"+err);
        }
      })();
      `;
    }

    // ---------------- Orchestrate one send operation ----------------
    function startOperation(){
      if (op && op.windowTimer) { clearTimeout(op.windowTimer); }
      op = { id: ("op-"+Date.now()+"-"+Math.random().toString(36).slice(2)), armed:false, sent:false, buffers:[], windowTimer:null, lastPreBuf:null };

      const script = buildPhotopeaScript(op.id);
      window.parent.postMessage(script, PHOTOPEA_ORIGIN);
      setStatus("Requesting active layer from Photopea…");
      L("Requested active layer (copy→new→paste→OE). opId=", op.id);
    }

    // ---------------- Delivery to Lab ----------------
    function pickAndSendBufferForCurrentOp(){
      if (!op || op.sent) return;

      let candidate = null;
      if (op.buffers.length) {
        candidate = op.buffers[op.buffers.length - 1];
        L("Picked POST buffer", candidate.byteLength, "bytes", "opId=", op.id);
      } else if (op.lastPreBuf && (Date.now() - op.lastPreBuf.t) <= PRE_BUFFER_WINDOW_MS) {
        candidate = op.lastPreBuf.ab;
        L("Picked fallback PRE buffer", candidate.byteLength, "bytes", "opId=", op.id);
      }

      if (!candidate) {
        L("No buffers collected around saveToOE (opId=", op.id, ")");
        return;
      }

      pendingPng  = candidate;
      pendingName = "from-photopea.png";
      sendImageToLab();
      op.sent = true;
    }

    function sendImageToLab(){
      if (!labWin || labWin.closed) { setStatus("Lab tab is not available."); return; }
      if (!pendingPng) { setStatus("No image to send."); return; }

      pendingSeq = ++seqCounter;
      appliedTries = 0;
      if (appliedTimer) { clearTimeout(appliedTimer); appliedTimer = null; }

      const crc = crc32_ab(pendingPng);
      const msg = { type:"LAB_IMAGE", sessionId, seq: pendingSeq, mime:"image/png", name: pendingName, buffer: pendingPng, crc };
      labWin.postMessage(msg, LAB_ORIGIN);
      LL("→ LAB_IMAGE (seq="+pendingSeq+", no transfer)", {size: pendingPng.byteLength, name: pendingName, crc});

      waitForAppliedThenFocus();
    }

    function waitForAppliedThenFocus(){
      if (appliedTimer) clearTimeout(appliedTimer);
      appliedTimer = setTimeout(()=>{
        if (appliedTries >= APPLIED_RETRIES) {
          setStatus("Waiting for Distort Lab… (image not confirmed).");
          L("LAB_IMAGE_APPLIED timeout for seq", pendingSeq);
          return;
        }
        appliedTries++;
        if (labWin && !labWin.closed && pendingPng && pendingSeq >= 0) {
          const crc = crc32_ab(pendingPng);
          labWin.postMessage({ type:"LAB_IMAGE", sessionId, seq: pendingSeq, mime:"image/png", name: pendingName, buffer: pendingPng, crc }, LAB_ORIGIN);
          LL("→ LAB_IMAGE (retry, seq="+pendingSeq+")");
          waitForAppliedThenFocus();
        }
      }, APPLIED_TIMEOUT_MS);
    }

    function waitForLabReadyThenSend(){
      let tries = 0;
      (function attempt(){
        if (labIsReady) { L("Lab is ready. Sending image."); sendImageToLab(); return; }
        if (tries > READY_RETRIES) { setStatus("Distort Lab did not respond. Allow pop-ups and try again."); L("LAB_READY timeout."); return; }
        tries++;
        sendLAB_OPEN();
        setTimeout(()=> labIsReady ? sendImageToLab() : attempt(), READY_TIMEOUT_MS);
      })();
    }

    // ---------------- Events ----------------
    sendBtn.addEventListener("click", ()=>{
      ensureSession();
      openOrFocusLab();
      sendLAB_OPEN();
      startOperation();
    });

    window.addEventListener("message", (ev)=>{
      // From Photopea
      if (ev.origin === PHOTOPEA_ORIGIN) {
        if (ev.data === "done") return;

        if (ev.data instanceof ArrayBuffer) {
          const now = Date.now();
          if (op) {
            if (op.armed && !op.sent) {
              op.buffers.push(ev.data);
              LP("Photopea → plugin: ArrayBuffer (POST armed)", ev.data.byteLength, "bytes", "opId=", op.id, "count=", op.buffers.length);
            } else {
              op.lastPreBuf = { ab: ev.data, t: now };
              LP("Photopea → plugin: ArrayBuffer (PRE captured)", ev.data.byteLength, "bytes", "opId=", op.id);
            }
          } else {
            LP("Photopea → plugin: ArrayBuffer (no active op, ignored)");
          }
          return;
        }

        if (typeof ev.data === "string") {
          const s = ev.data;
          LP("Photopea:", s);

          // Arm at :saveToOE:pre
          if (op && s.indexOf("pp:op:"+op.id+":saveToOE:pre") === 0) {
            op.armed = true;
            if (op.windowTimer) clearTimeout(op.windowTimer);

            op.windowTimer = setTimeout(()=>{
              pickAndSendBufferForCurrentOp();
              op.windowTimer = null;
            }, POST_BUFFER_WINDOW_MS);

            setStatus("Waiting for image buffer after save…");
          }
          return;
        }
      }

      // From Lab
      if (ev.origin === LAB_ORIGIN) {
        const msg = ev.data || {};
        if (!msg || msg.sessionId !== sessionId) return;

        if (msg.type === "LAB_READY") {
          labIsReady = true;
          LL("← LAB_READY");
          setStatus("Distort Lab is ready.");
          if (pendingPng) sendImageToLab();
          return;
        }

        if (msg.type === "LAB_IMAGE_APPLIED") {
          if (typeof msg.seq === "number" && msg.seq === pendingSeq) {
            LL("← LAB_IMAGE_APPLIED seq="+msg.seq);
            pendingPng = null;
            if (appliedTimer) { clearTimeout(appliedTimer); appliedTimer = null; }
            setStatus("Image applied in Distort Lab.");
            try { labWin && labWin.focus(); } catch(e){}
          } else {
            LL("← LAB_IMAGE_APPLIED (stale) seq="+msg.seq+" while pendingSeq="+pendingSeq);
          }
          return;
        }

        if (msg.type === "LAB_EXPORT" && msg.buffer instanceof ArrayBuffer) {
          LL("← LAB_EXPORT", msg.buffer.byteLength, "bytes");
          window.parent.postMessage(msg.buffer, PHOTOPEA_ORIGIN, [msg.buffer]);
          setStatus("Exported back to Photopea as a new document.");
          try { window.parent.focus(); } catch {}
          return;
        }
      }
    });
  })();
  </script>
</body>
</html>
