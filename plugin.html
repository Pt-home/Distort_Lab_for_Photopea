<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Distort Lab – Photopea Plugin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#151823; --line:#24283b; --text:#e6e6ea; --muted:#9aa0a6; --accent:#00a592;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--panel); color:var(--text);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{
      padding:12px; width:100%; max-width:520px;
    }
    h1{ font-size:16px; margin:0 0 6px; }
    p{ margin:0 0 10px; color:var(--muted); }
    .btn{
      width:100%;
      border:0; border-radius:10px; padding:10px 12px;
      cursor:pointer; font-weight:600;
      background:var(--accent); color:white;
    }
    .note{ margin-top:8px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Distort Lab for Photopea</h1>
    <p>Send the active layer to Distort Lab, tweak distortions, then export back as a new Photopea document.</p>
    <button id="sendBtn" class="btn">Send to Lab</button>
    <div class="note" id="status"></div>
  </div>

  <script>
  (function(){
    // --- Config ---
    const LAB_URL = "https://pt-home.github.io/Distort_Lab_for_Photopea/";
    const PHOTOPEA_ORIGIN = "https://www.photopea.com";
    const LAB_ORIGIN = "https://pt-home.github.io";

    // --- State ---
    let sessionId = null;
    let labWin = null;
    let labReady = false;

    const sendBtn = document.getElementById("sendBtn");
    const statusEl = document.getElementById("status");

    function log(msg){ statusEl.textContent = msg; }

    function ensureSession(){
      if (!sessionId) sessionId = "sess-" + Math.random().toString(36).slice(2);
      return sessionId;
    }

    function openOrFocusLab(){
      ensureSession();
      const url = LAB_URL + "?sessionId=" + encodeURIComponent(sessionId);
      if (!labWin || labWin.closed) {
        labWin = window.open(url, "_blank");
        labReady = false;
        log("Opening Distort Lab…");
      } else {
        labWin.focus();
        // Re-announce the session to an already open tab
        labWin.postMessage({ type:"LAB_OPEN", sessionId }, LAB_ORIGIN);
      }
    }

    function requestActiveLayerFromPhotopea(){
      // Script to export ONLY the active layer as PNG via saveToOE('png')
      // Steps: store visibility, hide all, show active, saveToOE, restore visibility.
      const script = `
      (function(){
        var d = app.activeDocument;
        if (!d) { app.echoToOE("no-document"); return; }
        var L = d.layers;
        if (!L || L.length === 0){ app.echoToOE("no-layers"); return; }

        var vis = [];
        for (var i=0; i<L.length; i++){ vis[i] = L[i].visible; L[i].visible = false; }
        var a = d.activeLayer;
        if (a) a.visible = true;

        // Export composite view (only active visible) to OE as PNG
        app.activeDocument.saveToOE("png");

        // Restore visibility
        for (var j=0; j<L.length; j++){ L[j].visible = vis[j]; }
        app.echoToOE("exported-active-layer");
      })();
      `;
      // Send the script string to Photopea parent frame
      window.parent.postMessage(script, PHOTOPEA_ORIGIN);
      log("Requesting active layer from Photopea…");
    }

    // --- Click handler: open/focus Lab, request PNG from Photopea ---
    sendBtn.addEventListener("click", () => {
      openOrFocusLab();
      // Let Lab know the session
      if (labWin && !labWin.closed) {
        labWin.postMessage({ type:"LAB_OPEN", sessionId }, LAB_ORIGIN);
      }
      // Ask Photopea to export the active layer as PNG (ArrayBuffer → message to us)
      requestActiveLayerFromPhotopea();
    });

    // --- Receive messages from Photopea (parent) and from Lab (child tab) ---
    window.addEventListener("message", (ev) => {
      // 1) From Photopea: ArrayBuffer (PNG) or service strings
      if (ev.origin === PHOTOPEA_ORIGIN) {
        if (ev.data === "done") {
          // Service ping from Photopea after operations
          return;
        }
        if (ev.data instanceof ArrayBuffer) {
          // Forward PNG to Lab tab
          if (labWin && !labWin.closed) {
            labWin.postMessage({
              type: "LAB_IMAGE",
              sessionId,
              mime: "image/png",
              name: "from-photopea.png",
              buffer: ev.data
            }, LAB_ORIGIN, [ev.data]); // transfer ownership
            log("Image sent to Distort Lab.");
          } else {
            log("Lab tab is not available.");
          }
          return;
        }
        // Other strings / echoes from Photopea scripts
        if (typeof ev.data === "string") {
          // Just show status text
          log("Photopea: " + ev.data);
          return;
        }
      }

      // 2) From Lab: LAB_EXPORT → forward buffer back to Photopea as new document
      if (ev.origin === LAB_ORIGIN) {
        const msg = ev.data || {};
        if (msg && msg.type === "LAB_EXPORT" && msg.sessionId === sessionId && msg.buffer instanceof ArrayBuffer) {
          // Send binary back to Photopea parent – it will open as a new document
          window.parent.postMessage(msg.buffer, PHOTOPEA_ORIGIN, [msg.buffer]);
          log("Exported back to Photopea as a new document.");
        }
        if (msg && msg.type === "LAB_OPEN" && msg.sessionId === sessionId) {
          labReady = true;
          log("Distort Lab is ready.");
        }
      }
    });
  })();
  </script>
</body>
</html>
